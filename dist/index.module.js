import{firstValueFrom as t,BehaviorSubject as e,Subject as n}from"rxjs";import{skip as r,filter as i,map as o}from"rxjs/operators";import{Buffer as s}from"buffer";import a from"crypto-js";import h from"secp256k1";function u(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function c(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function f(){return f=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},f.apply(this,arguments)}function d(t,e){return t<<e|t>>>32-e}var l=s.from("expand 32-byte k"),g=/*#__PURE__*/function(){function t(t,e){this.input=void 0,this.cachePos=void 0,this.buffer=void 0,this.output=void 0,this.input=new Uint32Array(16),this.input[0]=l.readUInt32LE(0),this.input[1]=l.readUInt32LE(4),this.input[2]=l.readUInt32LE(8),this.input[3]=l.readUInt32LE(12),this.input[4]=t.readUInt32LE(0),this.input[5]=t.readUInt32LE(4),this.input[6]=t.readUInt32LE(8),this.input[7]=t.readUInt32LE(12),this.input[8]=t.readUInt32LE(16),this.input[9]=t.readUInt32LE(20),this.input[10]=t.readUInt32LE(24),this.input[11]=t.readUInt32LE(28),this.input[12]=0,this.input[13]=e.readUInt32LE(0),this.input[14]=e.readUInt32LE(4),this.input[15]=e.readUInt32LE(8),this.cachePos=64,this.buffer=new Uint32Array(16),this.output=new s(64)}var e=t.prototype;return e.quarterRound=function(t,e,n,r){var i=this.buffer;i[t]+=i[e],i[r]=d(i[r]^i[t],16),i[n]+=i[r],i[e]=d(i[e]^i[n],12),i[t]+=i[e],i[r]=d(i[r]^i[t],8),i[n]+=i[r],i[e]=d(i[e]^i[n],7)},e.makeBlock=function(t,e){for(var n=-1;++n<16;)this.buffer[n]=this.input[n];for(n=-1;++n<10;)this.quarterRound(0,4,8,12),this.quarterRound(1,5,9,13),this.quarterRound(2,6,10,14),this.quarterRound(3,7,11,15),this.quarterRound(0,5,10,15),this.quarterRound(1,6,11,12),this.quarterRound(2,7,8,13),this.quarterRound(3,4,9,14);for(n=-1;++n<16;)this.buffer[n]+=this.input[n],t.writeUInt32LE(this.buffer[n],e),e+=4;if(this.input[12]++,!this.input[12])throw new Error("counter is exausted")},e.getBytes=function(t){var e=0,n=new s(t),r=64-this.cachePos;if(r){if(r>=t)return this.output.copy(n,0,this.cachePos,64),this.cachePos+=t,n;this.output.copy(n,0,this.cachePos,64),t-=r,e+=r,this.cachePos=64}for(;t>0;){if(t<=64)return this.makeBlock(this.output,0),this.output.copy(n,e,0,t),t<64&&(this.cachePos=t),n;this.makeBlock(n,e),t-=64,e+=64}throw new Error("something bad happended")},t}(),v=/*#__PURE__*/function(){function t(t){this.buffer=void 0,this.leftover=void 0,this.r=void 0,this.h=void 0,this.pad=void 0,this.finished=void 0,this.buffer=new s(16),this.leftover=0,this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.finished=0;var e,n=new Uint16Array(8);for(e=8;e--;)n[e]=t.readUInt16LE(2*e);for(this.r[0]=8191&n[0],this.r[1]=8191&(n[0]>>>13|n[1]<<3),this.r[2]=7939&(n[1]>>>10|n[2]<<6),this.r[3]=8191&(n[2]>>>7|n[3]<<9),this.r[4]=255&(n[3]>>>4|n[4]<<12),this.r[5]=n[4]>>>1&8190,this.r[6]=8191&(n[4]>>>14|n[5]<<2),this.r[7]=8065&(n[5]>>>11|n[6]<<5),this.r[8]=8191&(n[6]>>>8|n[7]<<8),this.r[9]=n[7]>>>5&127,e=8;e--;)this.h[e]=0,this.pad[e]=t.readUInt16LE(16+2*e);this.h[8]=0,this.h[9]=0,this.leftover=0,this.finished=0}var e=t.prototype;return e.blocks=function(t,e,n){for(var r=this.finished?0:2048,i=new Uint16Array(8),o=new Uint32Array(10),s=0,a=0,h=0;n>=16;){for(a=8;a--;)i[a]=t.readUInt16LE(2*a+e);for(this.h[0]+=8191&i[0],this.h[1]+=8191&(i[0]>>>13|i[1]<<3),this.h[2]+=8191&(i[1]>>>10|i[2]<<6),this.h[3]+=8191&(i[2]>>>7|i[3]<<9),this.h[4]+=8191&(i[3]>>>4|i[4]<<12),this.h[5]+=i[4]>>>1&8191,this.h[6]+=8191&(i[4]>>>14|i[5]<<2),this.h[7]+=8191&(i[5]>>>11|i[6]<<5),this.h[8]+=8191&(i[6]>>>8|i[7]<<8),this.h[9]+=i[7]>>>5|r,a=0,s=0;a<10;a++){for(o[a]=s,h=0;h<10;h++)o[a]+=(4294967295&this.h[h])*(h<=a?this.r[a-h]:5*this.r[a+10-h]),4===h&&(s=o[a]>>>13,o[a]&=8191);s+=o[a]>>>13,o[a]&=8191}for(s=(s<<2)+s,o[0]=8191&(s+=o[0]),o[1]+=s>>>=13,a=10;a--;)this.h[a]=o[a];e+=16,n-=16}},e.update=function(t){var e=t.length,n=0,r=0,i=0;if(this.leftover){for((n=16-this.leftover)>e&&(n=e),r=n;r--;)this.buffer[this.leftover+r]=t[r+i];if(e-=n,i+=n,this.leftover+=n,this.leftover<16)return this;this.blocks(this.buffer,0,16),this.leftover=0}if(e>=16&&(this.blocks(t,i,n=-16&e),i+=n,e-=n),e){for(r=e;r--;)this.buffer[this.leftover+r]=t[r+i];this.leftover+=e}return this},e.finish=function(){var t=new s(16),e=new Uint16Array(10),n=0,r=0,i=0,o=0;if(this.leftover){for(o=this.leftover,this.buffer[o++]=1;o<16;o++)this.buffer[o]=0;this.finished=1,this.blocks(this.buffer,0,16)}for(n=this.h[1]>>>13,this.h[1]&=8191,o=2;o<10;o++)this.h[o]+=n,n=this.h[o]>>>13,this.h[o]&=8191;for(this.h[0]+=5*n,n=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=n,n=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=n,e[0]=this.h[0]+5,n=e[0]>>>13,e[0]&=8191,o=1;o<10;o++)e[o]=this.h[o]+n,n=e[o]>>>13,e[o]&=8191;for(e[9]-=8192,r=(e[9]>>>15)-1,o=10;o--;)e[o]&=r;for(r=~r,o=10;o--;)this.h[o]=this.h[o]&r|e[o];for(this.h[0]=this.h[0]|this.h[1]<<13,this.h[1]=this.h[1]>>3|this.h[2]<<10,this.h[2]=this.h[2]>>6|this.h[3]<<7,this.h[3]=this.h[3]>>9|this.h[4]<<4,this.h[4]=this.h[4]>>12|this.h[5]<<1|this.h[6]<<14,this.h[5]=this.h[6]>>2|this.h[7]<<11,this.h[6]=this.h[7]>>5|this.h[8]<<8,this.h[7]=this.h[8]>>8|this.h[9]<<5,this.h[0]=i=(4294967295&this.h[0])+this.pad[0],o=1;o<8;o++)this.h[o]=i=(4294967295&this.h[o])+this.pad[o]+(i>>>16);for(o=8;o--;)t.writeUInt16LE(this.h[o],2*o),this.pad[o]=0;for(o=10;o--;)this.h[o]=0,this.r[o]=0;return t},t}(),p=/*#__PURE__*/function(){function t(t,e,n){void 0===n&&(n=!1),this.alen=void 0,this.clen=void 0,this.chacha=void 0,this.poly=void 0,this.tag=void 0,this._decrypt=void 0,this._hasData=void 0,this.alen=0,this.clen=0,this.chacha=new g(t,e),this.poly=new v(this.chacha.getBytes(64)),this.tag=null,this._decrypt=n,this._hasData=!1}var e=t.prototype;return e.setAAD=function(t){if(this._hasData)throw new Error("Attempting to set AAD in unsupported state");this.alen=t.length,this.poly.update(t);var e=new s(m(this.alen));e.length&&(e.fill(0),this.poly.update(e))},e.update=function(t,e,n){"string"==typeof t&&(t=s.from(t,e));var r=this._update(t)||s.from("");return n?r.toString(n):r},e.final=function(t){var e=this._final()||s.from("");return t?e.toString(t):e},e._update=function(t){this._hasData||(this._hasData=!0);var e=t.length;if(e){this.clen+=e;for(var n=this.chacha.getBytes(e),r=-1;++r<e;)n[r]^=t[r];return this.poly.update(this._decrypt?t:n),n}},e._final=function(){if(this._decrypt&&!this.tag)throw new Error("Unsupported state or unable to authenticate data");var t=new s(m(this.clen));t.length&&(t.fill(0),this.poly.update(t));var e=new s(16);e.fill(0),e.writeUInt32LE(this.alen,0),e.writeUInt32LE(this.clen,8);var n=this.poly.update(e).finish();if(this._decrypt){if(function(t,e){var n=0;t.length!==e.length&&n++;for(var r=Math.min(t.length,e.length),i=-1;++i<r;)n+=t[i]^e[i];return n}(n,this.tag))throw new Error("Unsupported state or unable to authenticate data")}else this.tag=n;return n},e.getAuthTag=function(){return this._decrypt||null===this.tag?new s(""):this.tag},e.setAuthTag=function(t){if(!this._decrypt)throw new Error("Attempting to set auth tag in unsupported state");this.tag=t},t}();function m(t){var e=t%16;return e?16-e:0}var _=function(t){try{return Promise.resolve(window.crypto.subtle.digest("SHA-256",t)).then(function(t){return s.from(t)})}catch(t){return Promise.reject(t)}};function y(t,e){return s.from(h.ecdh(t,e))}function w(t,e){var n=a.HmacSHA256(a.enc.Hex.parse(e.toString("hex")),a.enc.Hex.parse(t.toString("hex")));return s.from(a.enc.Hex.stringify(n),"hex")}function I(t,e,n,r){void 0===n&&(n=s.alloc(0)),void 0===r&&(r=s.alloc(0));var i=w(n,t),o=Math.ceil(e/i.byteLength);if(o>255)throw new Error("Output length exceeds maximum");for(var a=[s.alloc(0)],h=1;h<=o;h++){var u=a[a.length-1],c=s.from([h]);a.push(w(i,s.concat([u,r,c])))}return s.concat(a.slice(1)).subarray(0,e)}function B(t,e){return void 0===e&&(e=!0),s.from(h.publicKeyCreate(t,e))}function E(t,e,n,r){var i=new p(t,e);i.setAAD(n);var o=i.update(r);i.final&&i.final();var a=i.getAuthTag();return s.concat([o,a])}function b(t,e,n,r){var i=new p(t,e,!0);if(i.setAAD(n),16===r.length)return i.setAuthTag(r),i.final();if(r.length>16){var o=r.subarray(r.length-16),a=r.subarray(0,r.length-16);i.setAuthTag(o);var h=i.update(a),u=i.final();return s.concat([h,u])}}function R(){var t;do{var e=s.allocUnsafe(32);t=window.crypto.getRandomValues(e)}while(!U(t));return t.toString("hex")}function U(t){return h.privateKeyVerify("string"==typeof t?s.from(t,"hex"):t)}var k,P,A,S=/*#__PURE__*/function(){function t(t){var e=t.ls,n=t.es;this.protocolName=s.from("Noise_XK_secp256k1_ChaChaPoly_SHA256"),this.prologue=s.from("lightning"),this.ls=void 0,this.lpk=void 0,this.es=void 0,this.epk=void 0,this.rpk=void 0,this.repk=void 0,this.h=void 0,this.ck=void 0,this.rk=void 0,this.sk=void 0,this.sn=void 0,this.rn=void 0,this.tempK1=void 0,this.tempK2=void 0,this.tempK3=void 0,this.ls=e,this.lpk=B(e),this.es=n,this.epk=B(n)}var e=t.prototype;return e.initiatorAct1=function(t){try{var e=this;return e.rpk=t,Promise.resolve(e._initialize(e.rpk)).then(function(){return Promise.resolve(_(s.concat([e.h,e.epk]))).then(function(t){e.h=t;var n=I(y(e.rpk,e.es),64,e.ck);e.ck=n.subarray(0,32),e.tempK1=n.subarray(32);var r=E(e.tempK1,s.alloc(12),e.h,s.alloc(0));return Promise.resolve(_(s.concat([e.h,r]))).then(function(t){return e.h=t,s.concat([s.alloc(1),e.epk,r])})})})}catch(t){return Promise.reject(t)}},e.initiatorAct2=function(t){try{var e=this;if(50!==t.length)throw new Error("ACT2_READ_FAILED");var n=t.subarray(0,1)[0],r=t.subarray(1,34),i=t.subarray(34);if(e.repk=r,0!==n)throw new Error("ACT2_BAD_VERSION");return Promise.resolve(_(s.concat([e.h,e.repk]))).then(function(t){e.h=t;var n=I(y(e.repk,e.es),64,e.ck);return e.ck=n.subarray(0,32),e.tempK2=n.subarray(32),b(e.tempK2,s.alloc(12),e.h,i),Promise.resolve(_(s.concat([e.h,i]))).then(function(t){e.h=t})})}catch(t){return Promise.reject(t)}},e.initiatorAct3=function(){try{var t=this,e=E(t.tempK2,s.from([0,0,0,0,1,0,0,0,0,0,0,0]),t.h,t.lpk);return Promise.resolve(_(s.concat([t.h,e]))).then(function(n){t.h=n;var r=I(y(t.repk,t.ls),64,t.ck);t.ck=r.subarray(0,32),t.tempK3=r.subarray(32);var i=E(t.tempK3,s.alloc(12),t.h,s.alloc(0)),o=I(s.alloc(0),64,t.ck);return t.rk=o.subarray(32),t.sk=o.subarray(0,32),t.sn=s.alloc(12),t.rn=s.alloc(12),s.concat([s.alloc(1),e,i])})}catch(t){return Promise.reject(t)}},e.receiveAct1=function(t){try{var e=this;return Promise.resolve(e._initialize(e.lpk)).then(function(){if(50!==t.length)throw new Error("ACT1_READ_FAILED");var n=t.subarray(0,1)[0],r=t.subarray(1,34),i=t.subarray(34);if(e.repk=r,0!==n)throw new Error("ACT1_BAD_VERSION");return Promise.resolve(_(s.concat([e.h,r]))).then(function(t){e.h=t;var n=I(y(r,e.ls),64,e.ck);return e.ck=n.subarray(0,32),e.tempK1=n.subarray(32),b(e.tempK1,s.alloc(12),e.h,i),Promise.resolve(_(s.concat([e.h,i]))).then(function(t){e.h=t})})})}catch(t){return Promise.reject(t)}},e.recieveAct2=function(){try{var t=this;return Promise.resolve(_(s.concat([t.h,t.epk]))).then(function(e){t.h=e;var n=I(y(t.repk,t.es),64,t.ck);t.ck=n.subarray(0,32),t.tempK2=n.subarray(32);var r=E(t.tempK2,s.alloc(12),t.h,s.alloc(0));return Promise.resolve(_(s.concat([t.h,r]))).then(function(e){return t.h=e,s.concat([s.alloc(1),t.epk,r])})})}catch(t){return Promise.reject(t)}},e.receiveAct3=function(t){try{var e=this;if(66!==t.length)throw new Error("ACT3_READ_FAILED");var n=t.subarray(0,1)[0],r=t.subarray(1,50),i=t.subarray(50);if(0!==n)throw new Error("ACT3_BAD_VERSION");var o=b(e.tempK2,s.from("000000000100000000000000","hex"),e.h,r);return e.rpk=o,Promise.resolve(_(s.concat([e.h,r]))).then(function(t){e.h=t;var n=I(y(e.rpk,e.es),64,e.ck);e.ck=n.subarray(0,32),e.tempK3=n.subarray(32),b(e.tempK3,s.alloc(12),e.h,i);var r=I(s.alloc(0),64,e.ck);e.rk=r.subarray(0,32),e.sk=r.subarray(32),e.rn=s.alloc(12),e.sn=s.alloc(12)})}catch(t){return Promise.reject(t)}},e.encryptMessage=function(t){try{var e=this,n=s.alloc(2);n.writeUInt16BE(t.length,0);var r=E(e.sk,e.sn,s.alloc(0),n);e._incrementSendingNonce()>=1e3&&e._rotateSendingKeys();var i=E(e.sk,e.sn,s.alloc(0),t);return e._incrementSendingNonce()>=1e3&&e._rotateSendingKeys(),Promise.resolve(s.concat([r,i]))}catch(t){return Promise.reject(t)}},e.decryptLength=function(t){try{var e=this,n=b(e.rk,e.rn,s.alloc(0),t);return e._incrementRecievingNonce()>=1e3&&e._rotateRecievingKeys(),Promise.resolve(n.readUInt16BE(0))}catch(t){return Promise.reject(t)}},e.decryptMessage=function(t){try{var e=this,n=b(e.rk,e.rn,s.alloc(0),t);return e._incrementRecievingNonce()>=1e3&&e._rotateRecievingKeys(),Promise.resolve(n)}catch(t){return Promise.reject(t)}},e._initialize=function(t){try{var e=this;return Promise.resolve(_(s.from(e.protocolName))).then(function(n){return e.h=n,e.ck=e.h,Promise.resolve(_(s.concat([e.h,e.prologue]))).then(function(n){return e.h=n,Promise.resolve(_(s.concat([e.h,t]))).then(function(t){e.h=t})})})}catch(t){return Promise.reject(t)}},e._incrementSendingNonce=function(){var t=this.sn.readUInt16LE(4)+1;return this.sn.writeUInt16LE(t,4),t},e._incrementRecievingNonce=function(){var t=this.rn.readUInt16LE(4)+1;return this.rn.writeUInt16LE(t,4),t},e._rotateSendingKeys=function(){var t=I(this.sk,64,this.ck);this.sk=t.subarray(32),this.ck=t.subarray(0,32),this.sn=s.alloc(12)},e._rotateRecievingKeys=function(){var t=I(this.rk,64,this.ck);this.rk=t.subarray(32),this.ck=t.subarray(0,32),this.rn=s.alloc(12)},t}(),L=/*#__PURE__*/function(){function t(t){this._buffer=void 0,this._position=void 0,this._lastReadBytes=void 0,this._buffer=t,this._position=0,this._lastReadBytes=0}t.bigSizeBytes=function(t){return t<BigInt(253)?1:t<BigInt(65536)?3:t<BigInt(4294967296)?5:9};var e=t.prototype;return e.readUInt8=function(){return this._readStandard(this.readUInt8.name,1)},e.readUInt16LE=function(){return this._readStandard(this.readUInt16LE.name,2)},e.readUInt16BE=function(){return this._readStandard(this.readUInt16BE.name,2)},e.readUInt32LE=function(){return this._readStandard(this.readUInt32LE.name,4)},e.readUInt32BE=function(){return this._readStandard(this.readUInt32BE.name,4)},e.readUInt64BE=function(){return BigInt("0x"+this.readBytes(8).toString("hex"))},e.readUInt64LE=function(){return BigInt("0x"+this.readBytes(8).reverse().toString("hex"))},e.readVarUint=function(){var t=this.readUInt8();if(t<253)return this._lastReadBytes=1,BigInt(t);switch(t){case 253:return this._lastReadBytes=3,BigInt(this.readUInt16LE());case 254:return this._lastReadBytes=5,BigInt(this.readUInt32LE());case 255:return this._lastReadBytes=9,this.readUInt64LE()}},e.readBigSize=function(){var t=this.readUInt8();if(t<253)return this._lastReadBytes=1,BigInt(t);switch(t){case 253:this._lastReadBytes=3;var e=this.readUInt16BE();if(e<253)throw new Error("decoded varint is not canonical");return BigInt(e);case 254:this._lastReadBytes=5;var n=this.readUInt32BE();if(n<65536)throw new Error("decoded varint is not canonical");return BigInt(n);case 255:this._lastReadBytes=9;var r=this.readUInt64BE();if(r<BigInt(4294967296))throw new Error("decoded varint is not canonical");return r;default:throw new Error("Unrecognised size: "+t+" when trying to read BigSize")}},e.readBytes=function(t){if(0===t)return this._lastReadBytes=0,s.alloc(0);if("number"==typeof t&&t>0){if(this._position+t>this._buffer.length)throw new RangeError("Index out of range");var e=this._buffer.subarray(this._position,this._position+t),n=s.alloc(e.length,e);return this._position+=t,this._lastReadBytes=t,n}if(this._position===this._buffer.length)return this._lastReadBytes=0,s.alloc(0);var r=this._buffer.subarray(this._position),i=s.alloc(r.length,r);return this._position=this._buffer.length,this._lastReadBytes=i.length,i},e.peakBytes=function(t){if(0===t)return s.alloc(0);if("number"==typeof t&&t>0){if(this._position+t>this._buffer.length)throw new RangeError("Index out of range");var e=this._buffer.subarray(this._position,this._position+t);return s.alloc(e.length,e)}if(this._position===this._buffer.length)throw new RangeError("Index out of range");var n=this._buffer.subarray(this._position);return s.alloc(n.length,n)},e.readTUInt16=function(){var t=Math.min(2,this._buffer.length-this._position);if(0===t)return 0;var e=this._buffer.readUIntBE(this._position,t);return this._assertMinimalTUInt(BigInt(e),t),this._position+=t,e},e.readTUInt32=function(){var t=Math.min(4,this._buffer.length-this._position);if(0===t)return 0;var e=this._buffer.readUIntBE(this._position,t);return this._assertMinimalTUInt(BigInt(e),t),this._position+=t,e},e.readTUInt64=function(){var t=Math.min(8,this._buffer.length-this._position);if(0===t)return BigInt(0);var e=this._buffer.subarray(this._position,this._position+t).toString("hex")||"0",n=BigInt("0x"+e);return this._assertMinimalTUInt(n,t),this._position+=t,n},e._readStandard=function(t,e){if(this._position+e>this._buffer.length)throw new RangeError("Index out of range");var n=this._buffer[t](this._position);return this._position+=e,this._lastReadBytes=e,n},e._assertMinimalTUInt=function(t,e){for(var n=0;n<9;n++)if(t<BigInt("0x1"+"".padStart(2*n,"0"))&&e!==n)throw new Error("TUInt not minimal")},c(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"eof",get:function(){return this._position===this._buffer.length}},{key:"buffer",get:function(){return this._buffer}},{key:"lastReadBytes",get:function(){return this._lastReadBytes}}]),t}(),N=/*#__PURE__*/function(){function t(t){this._position=void 0,this._fixed=void 0,this._buffer=void 0,this._position=0,this._fixed=!!t,this._buffer=t||s.alloc(0)}var e=t.prototype;return e.toBuffer=function(){return this._fixed?this._buffer:this._buffer.subarray(0,this._position)},e.writeUInt8=function(t){this._writeStandard(this.writeUInt8.name,t,1)},e.writeUInt16LE=function(t){this._writeStandard(this.writeUInt16LE.name,t,2)},e.writeUInt16BE=function(t){this._writeStandard(this.writeUInt16BE.name,t,2)},e.writeUInt32LE=function(t){this._writeStandard(this.writeUInt32LE.name,t,4)},e.writeUInt32BE=function(t){this._writeStandard(this.writeUInt32BE.name,t,4)},e.writeUInt64LE=function(t){var e=BigInt(t);if(e<0||e>=Math.pow(BigInt(2),BigInt(64)))throw new RangeError('The value of "value" is out of range. It must be >= 0 and <= 18446744073709551615. Received '+t.toString());var n=s.from(e.toString(16).padStart(16,"0"),"hex");this.writeBytes(n.reverse())},e.writeUInt64BE=function(t){var e=BigInt(t);if(e<0||e>=Math.pow(BigInt(2),BigInt(64)))throw new RangeError('The value of "value" is out of range. It must be >= 0 and <= 18446744073709551615. Received '+t.toString());var n=s.from(e.toString(16).padStart(16,"0"),"hex");this.writeBytes(n)},e.writeBytes=function(t){t&&t.length&&(this._expand(t.length),t.copy(this._buffer,this._position),this._position+=t.length)},e.writeVarInt=function(t){var e=BigInt(t);e<BigInt(253)?this.writeUInt8(Number(e)):e<BigInt(65536)?(this.writeUInt8(253),this.writeUInt16LE(Number(e))):e<BigInt(4294967296)?(this.writeUInt8(254),this.writeUInt32LE(Number(e))):(this.writeUInt8(255),this.writeUInt64LE(e))},e.writeBigSize=function(t){var e=BigInt(t);e<BigInt(253)?this.writeUInt8(Number(e)):e<BigInt(65536)?(this.writeUInt8(253),this.writeUInt16BE(Number(e))):e<BigInt(4294967296)?(this.writeUInt8(254),this.writeUInt32BE(Number(e))):(this.writeUInt8(255),this.writeUInt64BE(e))},e.writeTUInt16=function(t){if(0!==t){var e=t>255?2:1;this._expand(e),this._buffer.writeUIntBE(t,this._position,e),this._position+=e}},e.writeTUInt32=function(t){if(0!==t){var e=t>16777215?4:t>65535?3:t>255?2:1;this._expand(e),this._buffer.writeUIntBE(t,this._position,e),this._position+=e}},e.writeTUInt64=function(t){if(t!==BigInt(0)){var e=t.toString(16);e.length%2==1&&(e="0"+e);var n=s.from(e,"hex");this.writeBytes(n)}},e._expand=function(t){var e=this._position+t;if(this._fixed&&e>this._buffer.length)throw new RangeError("Out of range");if(this._buffer.length<e){var n=1<<Math.ceil(Math.log2(e)),r=s.alloc(n);this._buffer.copy(r),this._buffer=r}},e._writeStandard=function(t,e,n){this._expand(n),this._buffer[t](e,this._position),this._position+=n},c(t,[{key:"size",get:function(){return this._position}}]),t}(),C=/*#__PURE__*/function(){function t(t){this.value=void 0,this.value=t||BigInt(0)}t.fromNumber=function(e){return new t(BigInt(e))},t.fromBuffer=function(e){return 0===e.length?new t:new t(BigInt("0x"+e.toString("hex")))};var e=t.prototype;return e.isSet=function(t){return(this.value&BigInt(1)<<BigInt(t))>BigInt(0)},e.set=function(t){this.value|=BigInt(1)<<BigInt(t)},e.unset=function(t){this.value&=~(this.value&BigInt(1)<<BigInt(t))},e.toggle=function(t){this.value^=BigInt(1)<<BigInt(t)},e.flags=function(){for(var t=[],e=0,n=1n;n<this.value;)this.value&n&&t.push(e),e+=1,n<<=1n;return t},e.msb=function(){for(var t=this.value,e=0;t>1;)t>>=1n,e+=1;return e},e.and=function(e){return new t(this.value&e.value)},e.or=function(e){return new t(this.value|e.value)},e.xor=function(e){return new t(this.value^e.value)},e.toBigInt=function(){return this.value},e.toNumber=function(){return Number(this.value)},e.toBuffer=function(){return this.value===BigInt(0)?s.alloc(0):(e=function(t){for(var e=0;t>BigInt(0);)e+=1,t/=BigInt(Math.pow(2,8));return e}(t=this.value),s.from(t.toString(16).padStart(2*e,"0"),"hex"));var t,e},t}();!function(t){t[t.Init=16]="Init",t[t.Error=17]="Error",t[t.Ping=18]="Ping",t[t.Pong=19]="Pong",t[t.OpenChannel=32]="OpenChannel",t[t.AcceptChannel=33]="AcceptChannel",t[t.FundingCreated=34]="FundingCreated",t[t.FundingSigned=35]="FundingSigned",t[t.FundingLocked=36]="FundingLocked",t[t.Shutdown=38]="Shutdown",t[t.ClosingSigned=39]="ClosingSigned",t[t.ChannelAnnouncement=256]="ChannelAnnouncement",t[t.NodeAnnouncement=257]="NodeAnnouncement",t[t.ChannelUpdate=258]="ChannelUpdate",t[t.AnnouncementSignatures=259]="AnnouncementSignatures",t[t.QueryShortChannelIds=261]="QueryShortChannelIds",t[t.ReplyShortChannelIdsEnd=262]="ReplyShortChannelIdsEnd",t[t.QueryChannelRange=263]="QueryChannelRange",t[t.ReplyChannelRange=264]="ReplyChannelRange",t[t.GossipTimestampFilter=265]="GossipTimestampFilter",t[t.CommandoRequest=19535]="CommandoRequest",t[t.CommandoResponseContinues=22859]="CommandoResponseContinues",t[t.CommandoResponse=22861]="CommandoResponse"}(k||(k={})),function(t){t[t.INITIATOR_INITIATING=0]="INITIATOR_INITIATING",t[t.AWAITING_INITIATOR=1]="AWAITING_INITIATOR",t[t.AWAITING_RESPONDER_REPLY=2]="AWAITING_RESPONDER_REPLY",t[t.AWAITING_INITIATOR_REPLY=3]="AWAITING_INITIATOR_REPLY",t[t.READY=100]="READY"}(P||(P={})),function(t){t[t.READY_FOR_LEN=2]="READY_FOR_LEN",t[t.READY_FOR_BODY=3]="READY_FOR_BODY",t[t.BLOCKED=4]="BLOCKED"}(A||(A={}));var T=/*#__PURE__*/function(){function t(){this.type=k.Init,this.features=new C,this.chainHashes=[]}return t.deserialize=function(e){var n=new t,r=new L(e);r.readUInt16BE();var i=r.readUInt16BE(),o=C.fromBuffer(r.readBytes(i)),s=r.readUInt16BE(),a=C.fromBuffer(r.readBytes(s));return n.features=(new C).or(o).or(a),function(t,e){for(var n=BigInt(-1);!t.eof;)try{var r=t.readBigSize(),i=t.readBigSize(),o=t.readBytes(Number(i)),s=new L(o);if(r<=n)throw new Error("Invalid TLV stream");var a=r%BigInt(2)===BigInt(0),h=e(r,s);if(!h&&a)throw new Error("Unknown even type");if(h&&!s.eof)throw new Error("Non-canonical length");n=r}catch(t){}}(r,function(t,e){if(t===BigInt(1)){for(;!e.eof;){var r=e.readBytes(32);n.chainHashes.push(r)}return!0}return!1}),n},t.prototype.serialize=function(){var t=new N;t.writeUInt16BE(this.type),t.writeUInt16BE(0);var e=s.from([0,0,0,0,0,0,0,0]);return t.writeUInt16BE(e.length),t.writeBytes(e),this.chainHashes.length&&(t.writeBigSize(1),t.writeBigSize(32*this.chainHashes.length),t.writeBytes(s.concat(this.chainHashes))),t.toBuffer()},t}(),x=/*#__PURE__*/function(){function t(){this.type=k.Ping,this.numPongBytes=1,this.ignored=s.alloc(0)}return t.deserialize=function(e){var n=new L(e);n.readUInt16BE();var r=new t;r.numPongBytes=n.readUInt16BE();var i=n.readUInt16BE();return r.ignored=n.readBytes(i),r},t.prototype.serialize=function(){var t=new N(s.alloc(6+this.ignored.length));return t.writeUInt16BE(this.type),t.writeUInt16BE(this.numPongBytes),t.writeUInt16BE(this.ignored.length),t.writeBytes(this.ignored),t.toBuffer()},c(t,[{key:"triggersReply",get:function(){return this.numPongBytes<65532}}]),t}(),M=/*#__PURE__*/function(){function t(t){void 0===t&&(t=0),this.type=k.Pong,this.ignored=void 0,this.ignored=s.alloc(t)}return t.deserialize=function(e){var n=new t,r=new L(e);r.readUInt16BE();var i=r.readUInt16BE();return n.ignored=r.readBytes(i),n},t.prototype.serialize=function(){var t=new N(s.alloc(+this.ignored.length+4));return t.writeUInt16BE(this.type),t.writeUInt16BE(this.ignored.length),t.writeBytes(this.ignored),t.toBuffer()},t}(),O=/*#__PURE__*/function(){function t(){this.type=k.CommandoResponse,this.id=void 0,this.response=void 0}return t.deserialize=function(e){var n=new t,r=new L(e);r.readUInt16BE(),n.id=r.readBytes(8).toString("hex");var i=r.readBytes(e.byteLength-26).toString();try{n.response=JSON.parse(i)}catch(t){n.response={jsonrpc:"2.0",id:null,error:{code:1,message:"Could not parse json response"}}}return n},t}();function D(t,e,n){if(!t.s){if(n instanceof K){if(!n.s)return void(n.o=D.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(D.bind(null,t,e),D.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}var K=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){var r=new t,i=this.s;if(i){var o=1&i?e:n;if(o){try{D(r,1,o(this.v))}catch(t){D(r,2,t)}return r}return this}return this.o=function(t){try{var i=t.v;1&t.s?D(r,1,e?e(i):i):n?D(r,1,n(i)):D(r,2,i)}catch(t){D(r,2,t)}},r},t}();function j(t,e){var n,r=-1;t:{for(var i=0;i<e.length;i++){var o=e[i][0];if(o){var s=o();if(s&&s.then)break t;if(s===t){r=i;break}}else r=i}if(-1!==r){do{for(var a=e[r][1];!a;)r++,a=e[r][1];var h=a();if(h&&h.then){n=!0;break t}var u=e[r][2];r++}while(u&&!u());return h}}var c=new K,f=D.bind(null,c,2);return(n?h.then(d):s.then(function n(s){for(;;){if(s===t){r=i;break}if(++i===e.length){if(-1!==r)break;return void D(c,1,h)}if(o=e[i][0]){if((s=o())&&s.then)return void s.then(n).then(void 0,f)}else r=i}do{for(var a=e[r][1];!a;)r++,a=e[r][1];var h=a();if(h&&h.then)return void h.then(d).then(void 0,f);var u=e[r][2];r++}while(u&&!u());D(c,1,h)})).then(void 0,f),c;function d(t){for(;;){var n=e[r][2];if(!n||n())break;r++;for(var i=e[r][1];!i;)r++,i=e[r][1];if((t=i())&&t.then)return void t.then(d).then(void 0,f)}D(c,1,t)}}function z(t){return t instanceof K&&1&t.s}var $=/*#__PURE__*/function(){function a(t){var r=this;this.noise=void 0,this.remoteNodePublicKey=void 0,this.publicKey=void 0,this.privateKey=void 0,this.wsUrl=void 0,this.socket=void 0,this.connected$=void 0,this.connecting=void 0,this.decryptedMsgs$=void 0,this.commandoMsgs$=void 0,this.Buffer=void 0,this._ls=void 0,this._es=void 0,this._handshakeState=void 0,this._readState=void 0,this._decryptedMsgs$=void 0,this._commandoMsgs$=void 0,this._partialCommandoMsgs=void 0,this._attemptedReconnects=void 0,this._logger=void 0,this._attemptReconnect=void 0,this._messageBuffer=void 0,this._processingBuffer=void 0,this._l=void 0,function(t){var e=t.remoteNodePublicKey,n=t.wsProxy,r=t.privateKey,i=t.ip,o=t.port,a=t.logger;if(!e||!h.publicKeyVerify(s.from(e,"hex")))throw new Error(e+" is not a valid public key");if(!i||!i.match(/^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)(\.(?!$)|$)){4}$/))throw new Error(i+" is not a valid IP address");if(!o||o<1||o>65535)throw new Error(o+" is not a valid port number");if(n){var u=n+" is not a valid url";try{var c=new URL(n);if("wss:"!==c.protocol&&"ws:"!==c.protocol)throw new Error(u)}catch(t){throw new Error(u)}}if(r&&!U(r))throw new Error(r+" is not a valid private key");if(a){if("object"!=typeof a)throw new Error("Logger must be of type object");var f=["info","warn","error"];Object.entries(a).forEach(function(t){var e=t[0],n=t[1];if(!f.includes(e))throw new Error("Invalid logger level: "+e);if("function"!=typeof n)throw new Error("Logger for level: "+e+" is not a function")})}}(t);var i=t.remoteNodePublicKey,a=t.wsProxy,u=t.ip,c=t.port,d=void 0===c?9735:c,l=t.logger;this._ls=s.from(t.privateKey||R(),"hex"),this._es=s.from(R(),"hex"),this.noise=new S({ls:this._ls,es:this._es}),this.remoteNodePublicKey=i,this.publicKey=this.noise.lpk.toString("hex"),this.privateKey=this._ls.toString("hex"),this.wsUrl=a?a+"/"+u+":"+d:"wss://"+i+"@"+u+":"+d,this.connected$=new e(!1),this.connecting=!1,this.Buffer=s,this._handshakeState=P.INITIATOR_INITIATING,this._decryptedMsgs$=new n,this.decryptedMsgs$=this._decryptedMsgs$.asObservable(),this._commandoMsgs$=new n,this.commandoMsgs$=this._commandoMsgs$.asObservable().pipe(o(function(t){return f({},t.response,{reqId:t.id})})),this._partialCommandoMsgs={},this._attemptedReconnects=0,this._logger=l,this._readState=A.READY_FOR_LEN,this._processingBuffer=!1,this._l=null,this.decryptedMsgs$.subscribe(function(t){r.handleDecryptedMessage(t)})}var u=a.prototype;return u.connect=function(e){void 0===e&&(e=!0);try{var n=this;return n.connected$.getValue()?Promise.resolve(!0):(n.connecting=!0,n._log("info","Initiating connection to node "+n.remoteNodePublicKey),n._attemptReconnect=e,n._attemptedReconnects+=1,n.socket=new WebSocket(n.wsUrl),n.socket.binaryType="arraybuffer",n.socket.onopen=function(){try{return n._log("info","WebSocket is connected"),n._log("info","Creating Act1 message"),Promise.resolve(n.noise.initiatorAct1(s.from(n.remoteNodePublicKey,"hex"))).then(function(t){n.socket&&(n._log("info","Sending Act1 message"),n.socket.send(t),n._handshakeState=P.AWAITING_RESPONDER_REPLY)})}catch(t){return Promise.reject(t)}},n.socket.onclose=function(){try{n._log("error","WebSocket is closed"),n._log("info","Attempted reconnects: "+n._attemptedReconnects),n.connected$.next(!1);var t=function(){if(n._attemptReconnect&&n._attemptedReconnects<5)return n.connecting=!0,n._log("info","Waiting to reconnect"),Promise.resolve(new Promise(function(t){return setTimeout(t,1e3*(n._attemptedReconnects||1))})).then(function(){n.connect()})}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},n.socket.onerror=function(t){n._log("error","WebSocket error: "+JSON.stringify(t))},n.socket.onmessage=n.queueMessage.bind(n),Promise.resolve(t(n.connected$.pipe(r(1)))))}catch(t){return Promise.reject(t)}},u.queueMessage=function(t){var e=s.from(t.data),n=this._messageBuffer&&!this._messageBuffer.eof&&this._messageBuffer.readBytes();this._messageBuffer=new L(n?s.concat([n,e]):e),this._processingBuffer||(this._processingBuffer=!0,this._processBuffer())},u.disconnect=function(){this._log("info","Manually disconnecting from WebSocket"),this.noise=new S({ls:this._ls,es:this._es}),this._attemptReconnect=!1,this.socket&&this.socket.close()},u._processBuffer=function(){try{var t=function(t){if(_interrupt3)return t;e._processingBuffer=!1},e=this,n=Y(function(){var t=!0;return function(t,e){var n;do{var r=t();if(r&&r.then){if(!z(r)){n=!0;break}r=r.v}var i=e();if(z(i)&&(i=i.v),!i)return r}while(!i.then);const o=new K,s=D.bind(null,o,2);return(n?r.then(a):i.then(h)).then(void 0,s),o;function a(n){for(r=n;z(i=e())&&(i=i.v),i;){if(i.then)return void i.then(h).then(void 0,s);if((r=t())&&r.then){if(!z(r))return void r.then(a).then(void 0,s);r=r.v}}D(o,1,r)}function h(n){if(n){do{if((r=t())&&r.then){if(!z(r))return void r.then(a).then(void 0,s);r=r.v}if(z(n=e())&&(n=n.v),!n)return void D(o,1,r)}while(!n.then);n.then(h).then(void 0,s)}else D(o,1,r)}}(function(){return e._handshakeState!==P.READY?j(e._handshakeState,[[function(){return P.INITIATOR_INITIATING},function(){throw new Error("Received data before intialised")}],[function(){return P.AWAITING_RESPONDER_REPLY},function(){return Promise.resolve(e._processResponderReply()).then(function(e){t=e})}]]):j(e._readState,[[function(){return A.READY_FOR_LEN},function(){return Promise.resolve(e._processPacketLength()).then(function(e){t=e})}],[function(){return A.READY_FOR_BODY},function(){return Promise.resolve(e._processPacketBody()).then(function(e){t=e})}],[function(){return A.BLOCKED},function(){t=!1}],[void 0,function(){throw new Error("Unknown read state")}]])},function(){return!_interrupt3&&!!t})},function(){e.disconnect()});return Promise.resolve(n&&n.then?n.then(t):t(n))}catch(t){return Promise.reject(t)}},u._processResponderReply=function(){try{var t=this,e=t._messageBuffer.readBytes(50);if(50!==e.byteLength)throw new Error("Invalid message received from remote node");return t._log("info","Validating message as part of Act2"),Promise.resolve(t.noise.initiatorAct2(e)).then(function(){return t._log("info","Creating reply for Act3"),Promise.resolve(t.noise.initiatorAct3()).then(function(e){return t.socket&&(t._log("info","Sending reply for act3"),t.socket.send(e),t._handshakeState=P.READY),!0})})}catch(t){return Promise.reject(t)}},u._processPacketLength=function(){var t=this;return Promise.resolve(Y(function(){var e=t._messageBuffer.readBytes(18);return!!e&&Promise.resolve(t.noise.decryptLength(e)).then(function(e){return t._l=e,t._readState=A.READY_FOR_BODY,!0})},function(){return!1}))},u._processPacketBody=function(){try{var t=this;return Promise.resolve(!!t._l&&Y(function(){var e=t._messageBuffer.readBytes(t._l+16);return!!e&&Promise.resolve(t.noise.decryptMessage(e)).then(function(e){return t._l=null,t._decryptedMsgs$.next(e),t._readState=A.READY_FOR_LEN,!0})},function(){return!1}))}catch(t){return Promise.reject(t)}},u.handleDecryptedMessage=function(t){try{var e=this;return Promise.resolve(Y(function(){var n=new L(t),r=n.readUInt16BE(),i=(Object.entries(k).find(function(t){return t[1]===r})||[])[0],o=n.readBytes(8).toString("hex"),a=n.readBytes();if(e._log("info","Message type is: "+(i||"unknown")),r===k.CommandoResponseContinues)return e._log("info","Received a partial commando message, caching it to join with other parts"),void(e._partialCommandoMsgs[o]=e._partialCommandoMsgs[o]?s.concat([e._partialCommandoMsgs[o],a.subarray(0,a.byteLength-16)]):t.subarray(0,t.length-16));r===k.CommandoResponse&&e._partialCommandoMsgs[o]&&(e._log("info","Received a final commando msg and we have a partial message to join it to. Joining now"),t=s.concat([e._partialCommandoMsgs[o],a]),delete e._partialCommandoMsgs[o]),e._log("info","Deserialising payload");var h=function(t){var e=t.readUInt16BE(0);switch(e){case k.Init:return T.deserialize(t);case k.Ping:return x.deserialize(t);case k.Pong:return M.deserialize(t);case k.CommandoResponse:case k.CommandoResponseContinues:return O.deserialize(t)}return{type:e}}(t),u=j(h.type,[[function(){return k.Init},function(){return e._log("info","Constructing Init message reply"),Promise.resolve(e.noise.encryptMessage(h.serialize())).then(function(t){e.socket&&(e._log("info","Sending Init message reply"),e.socket.send(t),e._log("info","Connected and ready to send messages!"),e.connected$.next(!0),e.connecting=!1,e._attemptedReconnects=0)})}],[function(){return k.Ping},function(){e._log("info","Received a Ping message"),e._log("info","Creating a Pong message");var t=new M(h.numPongBytes).serialize();return Promise.resolve(e.noise.encryptMessage(t)).then(function(t){e.socket&&(e._log("info","Sending a Pong message"),e.socket.send(t))})}],[function(){return k.CommandoResponse},function(){e._commandoMsgs$.next(h)},function(){}]]);return u&&u.then?u.then(function(){}):void 0},function(t){e._log("error","Error handling incoming message: "+t.message)}))}catch(t){return Promise.reject(t)}},u.commando=function(e){var n=e.method,r=e.params,o=void 0===r?[]:r,a=e.rune,h=e.reqId;try{var u=function(){var e=new N;if(!h){var r=s.allocUnsafe(8),u=window.crypto.getRandomValues(r);h=u.toString("hex")}return e.writeUInt16BE(k.CommandoRequest),e.writeBytes(s.from(h,"hex")),e.writeBytes(s.from(JSON.stringify({rune:a,method:n,params:o}))),c._log("info","Creating message to send"),Promise.resolve(c.noise.encryptMessage(e.toBuffer())).then(function(e){if(c.socket)return c._log("info","Sending commando message"),c.socket.send(e),c._log("info","Message sent and awaiting response"),Promise.resolve(t(c._commandoMsgs$.pipe(i(function(t){return t.id===h})))).then(function(t){var e=t.response,n=e.result,r=e.error;if(c._log("info",n?"Successful response received":"Error response received: "+r.message),r)throw r;return n});throw new Error("No socket initialised and connected")})},c=this;c._log("info","Commando request method: "+n+" params: "+JSON.stringify(o));var f=c.connected$.getValue()||c.connecting?(c._log("info","Ensuring we have a connection before making request"),Promise.resolve(t(c.connected$.pipe(i(function(t){return!0===t})))).then(function(){})):(c._log("info","No socket connection, so creating one now"),Promise.resolve(c.connect()).then(function(){}));return Promise.resolve(f&&f.then?f.then(u):u())}catch(t){return Promise.reject(t)}},u._log=function(t,e){this._logger&&this._logger[t]&&this._logger[t]("["+t.toUpperCase()+" - "+(new Date).toLocaleTimeString()+"]: "+e)},a}();function Y(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}export{$ as default};
//# sourceMappingURL=index.module.js.map
